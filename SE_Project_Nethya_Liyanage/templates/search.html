<!-- IMPORTANT - must run server on python -m http.server 8000 so files are accessible -->
<!-- search bar: https://www.w3schools.com/php/php_ajax_livesearch.asp -->
{% extends "base.html" %}

{% block title %} Predict {% endblock %}

{% block style %}
<style>
    .search-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }
    #livesearch {
        margin-top: 10px;
        border: 1px solid #ccc;
        padding: 10px;
        max-width: 400px;
        text-align: left;
        margin-bottom: 20px;
      }
    .result {
        padding: 4px;
    }
    .result:hover {
        background-color: #f0f0f0; /* Choose the colour you'd like */
    }
</style>
{% endblock %}

{% block masthead_title %} Predict {% endblock %}

{% block content %}

<div id="error-message" style="padding: 20px;"></div>

<div style='padding: 20px;'>
  <h1> Search </h1>

<div class='container'>
  <div class='row justify-content-center'>
    <input
      type="text"
      id="search"
      class="form-control w-50"
      placeholder="Search dictionary..."
      onkeyup="showResult(this.value)"
    />
  </div>
  <div id="livesearch" class="mt-3 mx-auto" style="max-width: 400px;"></div>
</div>
  
<script>
  let dictData = {};

  fetch("/static/test_fasta_dict.json")
    .then(response => response.json())
    .then(data => {
      dictData = data;
      console.log("Dictionary data loaded:", dictData);
    })
    .catch(error => console.error("Error loading JSON:", error));

  function showResult(input) {
    const searchQuery = input.toLowerCase().trim();
    const resultsContainer = document.getElementById("livesearch");
    let output = "";

    if (searchQuery.length === 0) {
      resultsContainer.innerHTML = "";
      return;
    }

    for (const key in dictData) {
      if (Object.prototype.hasOwnProperty.call(dictData, key)) {
        const value = dictData[key];
        if (
          key.toLowerCase().includes(searchQuery) ||
          value.toLowerCase().includes(searchQuery)
        ) {
          // Show key and first 20 characters of the value
          const preview = value.substring(0, 20) + (value.length > 20 ? "..." : "");
          output += `<div class="result" data-key="${key}"><b>${key}:</b> ${preview}</div>`;
        }
      }
    }
    resultsContainer.innerHTML = output || "No suggestion";
    
    document.querySelectorAll(".result").forEach(item => {
      item.addEventListener("click", function() {
        const selectedKey = this.getAttribute("data-key");
        console.log("User clicked:", selectedKey);
        predict(selectedKey);
      });
    });
    console.log("Search Query:", searchQuery);
  }

  function predict(key) {
    fetch('/predict', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ key: key })
    })
      .then(response => response.text())
      .then(html => {
        // Replace the current document with the new HTML page from the prediction endpoint.
        document.open();
        document.write(html);
        document.close();
      })
      .catch(error => {
        console.error('Prediction error:', error);
        document.getElementById("error-message").innerText = "A network error occurred";
      });
}

</script>

{% endblock %}


